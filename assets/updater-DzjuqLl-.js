import{__toESM as S}from"./chunk-DgAfPHQg.js";import{require_react as x}from"./react-CNoFhWkx.js";import"./index.web-BqgtOHN3.js";import"./es-Iwj7vF3u.js";import"./react-dom-xovCOntK.js";import"./react-is-BJXMVkew.js";import"./dist-Q7olfaoJ.js";import"./tslib.es6-Dbpxy1u8.js";import"./dist-QCpUvRkJ.js";import"./jsx-runtime-D7bMTQeG.js";import"./useEnabledChains-DuB86c95.js";import{logger as A}from"./hooks-BXO4d1DJ.js";import"./dist-ceZDlR1V.js";import"./analytics.web-DLc1_wTk.js";import"./redux-toolkit.esm-BnRUBto_.js";import{TransactionType as P,useActivityWebLazyQuery as g}from"./utils-BX1Fu73x.js";import"./bn-D7somgUb.js";import"./lib-DPFIyRke.js";import{buildCurrencyId as E}from"./currencyId-Ci6selsx.js";import"./config-C4KrHqHG.js";import"./time-D_OqcZ4M.js";import{FiatOnRampEventName as s}from"./features-yACC1hVw.js";import"./element-Wnp4RkdY.js";import"./isAddress-P2vaZgmG.js";import"./chain-ghiO403o.js";import"./slice-cfC6NcyN.js";import"./node-C_BraYgX.js";import"./formatUnits-DkyMpOD7.js";import"./_u64-b_viZRi_.js";import"./sha2-Jt0E41S_.js";import"./sha256-BqbhXHGu.js";import"./dist-CBK-d0jO.js";import"./hmac-D-QTodfL.js";import{require_ms as _}from"./ms-BqmEYo6j.js";import"./configs-B4dDdw82.js";import"./hooks-Bp0VtWbX.js";import"./statsig-B7I9iQRf.js";import{sendAnalyticsEvent as n}from"./send.web-CrSXW2rw.js";import{uniswapUrls as v}from"./urls-kwiZbYPW.js";import"./constants-D9cStT7K.js";import"./transactionDetails-BsNW_jus.js";import{PopupType as D,popupRegistry as T}from"./types-BSmAADNJ.js";import"./useAccount-C5hwiBwN.js";import{FOR_API_HEADERS as I,removeFiatOnRampTransaction as h,updateFiatOnRampTransaction as p}from"./constants-BNEwFtLH.js";import{useAppDispatch as U}from"./hooks-Muz170pO.js";import{FiatOnRampTransactionStatus as d,FiatOnRampTransactionType as y,backendStatusToFiatOnRampStatus as O,useFiatOnRampTransactions as b}from"./types-00FZ6Wno.js";import{statusToTransactionInfoStatus as w}from"./utils-CjNzOxi9.js";import{useInterval as F}from"./useInterval-7f86mkEJ.js";var m=S(_()),N=S(x());function _t(){var u;const i=b(),o=U(),[,l]=g();return F(()=>{Object.values(i).forEach(async t=>{if(!t.forceFetched&&t.type===y.BUY){const r={sessionId:t.externalSessionId,forceFetch:!0},e=await(await fetch(`${v.forApiUrl}/Transaction`,{headers:I,method:"POST",body:JSON.stringify(r)})).json();e!=null&&e.transaction?(o(p({...t,forceFetched:!0})),n(s.FiatOnRampTransactionUpdated,{status:d.PENDING,externalTransactionId:t.externalSessionId,serviceProvider:t.provider})):Date.now()-t.addedAt>(0,m.default)("10m")&&(o(h(t)),n(s.FiatOnRampTransactionUpdated,{status:d.FAILED,externalTransactionId:t.externalSessionId,serviceProvider:t.provider}))}})},(0,m.default)("30s")),F(()=>{Object.values(i).forEach(async t=>{if(t.type===y.SELL&&(!t.forceFetched||t.status===d.PENDING)){const r={sessionId:t.externalSessionId,forceFetch:!0},e=await(await fetch(`${v.forApiUrl}/Transaction`,{headers:I,method:"POST",body:JSON.stringify(r)})).json();if(e!=null&&e.transaction)if(!t.original)o(p({...t,original:e.transaction,forceFetched:!0}));else{const c=w(e.transaction.status);if(t.status!==c){const R=E(Number(e.transaction.cryptoDetails.chainId),e.transaction.tokenAddress),f=`forTransaction-${t.externalSessionId}`;T.removePopup(f),T.addPopup({type:D.FORTransaction,currencyId:R,transaction:e.transaction},f,1/0),o(p({...t,original:e.transaction,status:c}))}}else Date.now()-t.addedAt>(0,m.default)("10m")&&(o(h(t)),n(s.FiatOnRampTransactionUpdated,{status:d.FAILED,externalTransactionId:t.externalSessionId,serviceProvider:t.provider}))}})},(0,m.default)("5s")),(0,N.useEffect)(()=>{var t;(t=l.data)===null||t===void 0||(t=t.portfolios)===null||t===void 0||(t=t[0])===null||t===void 0||(t=t.assetActivities)===null||t===void 0||t.forEach(r=>{if((r==null?void 0:r.details.__typename)==="TransactionDetails"&&r.details.type===P.OnRamp&&r.details.assetChanges.length>0){const a=r.details.assetChanges[0];if((a==null?void 0:a.__typename)!=="OnRampTransfer"){A.error("Unexpected asset change type, expected OnRampTransfer",{tags:{file:"AssetActivityProvider",function:"useInterval"}});return}const e=i[a.externalSessionId];e&&(o(p({...e,syncedWithBackend:!0,status:O(r.details.status)})),n(s.FiatOnRampTransactionUpdated,{status:O(r.details.status),externalTransactionId:e.externalSessionId,serviceProvider:e.provider}))}})},[o,i,(u=l.data)===null||u===void 0?void 0:u.portfolios]),null}export{_t as default};
