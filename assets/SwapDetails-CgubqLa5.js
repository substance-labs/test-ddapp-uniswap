import{__toESM as C}from"./chunk-DgAfPHQg.js";import{require_react as pe}from"./react-CNoFhWkx.js";import{Button as K,Trans as j}from"./src-DOOtfpHS.js";import{useTranslation as ue}from"./useTranslation-BotBuoJf.js";import{require_jsx_runtime as le}from"./jsx-runtime-D7bMTQeG.js";import{CurrencyAmount as me,Percent as de,TradeType as fe,init_sdk_core_esm as ne}from"./utils-BX1Fu73x.js";import{SwapEventName as _e}from"./features-yACC1hVw.js";import{ElementName as X}from"./element-Wnp4RkdY.js";import{require_dist as oe,require_dist$1 as he}from"./V3DutchOrderTrade-Cl7yELmp.js";import{Pool as ye,init_v3_sdk_esm as ge}from"./v3-sdk.esm-CHH6GWR1.js";import{Pair as Z,init_v2_sdk_esm as xe}from"./v2-sdk.esm-CIiDMO7F.js";import{RouterPreference as ve,TradeFillType as re}from"./types-DbOmsKtk.js";import{require_ms as we}from"./ms-BqmEYo6j.js";import{AVERAGE_L1_BLOCK_TIME_MS as Y}from"./usePollingIntervalByChain-YBOfXXzb.js";import{formatPercentInBasisPointsNumber as $,formatPercentNumber as be,formatToDecimal as J,getDurationUntilTimestampSeconds as Ee,getTokenAddress as k,isClassicTrade as L,isLimitTrade as H,isUniswapXTradeType as Te}from"./analytics-Ccvj1WVk.js";import{TransactionOriginType as Ae,TransactionType as Ce}from"./transactionDetails-BsNW_jus.js";import{useTrace as Se}from"./TraceContext-Ddfk7zjz.js";import{useAccount as ie}from"./useAccount-C5hwiBwN.js";import{assume0xAddress as P}from"./wagmi-CsUiFCSO.js";import{useReadContract as Ie}from"./useReadContract-DodDFlY8.js";import{signTypedData as Pe}from"./signing-DH5GfhKu.js";import{UserRejectedRequestError as ee,toReadableError as Re}from"./errors-BaezSPLl.js";import{didUserReject as De}from"./swapErrorToUserReadableMessage-DgHZMHU-.js";import{Text as Le}from"./Loader-D83W8G1W.js";import{AlertTriangleFilled as Ne}from"./AlertTriangleFilled-C9tf2eUJ.js";import{computeRealizedPriceImpact as je}from"./prices-BzyZhpWW.js";import{LimitDisclaimer as ke}from"./LimitDisclaimer-C4dN_xEH.js";import{useHasPendingApproval as Ue,useHasPendingRevocation as Me,useTransactionAdder as Be}from"./hooks-BA_A7Su9.js";import{useEthersSigner as Oe}from"./useEthersSigner-kdo6Ipah.js";import{styled_components_default as U}from"./styled-components-DbVO3u5J.js";import{ThemedText as Ge}from"./text-CK4eXdYc.js";import{ExternalLink as qe}from"./Links-Xomrvpth.js";import{Column_default as We}from"./Column-ekA0cfjc.js";import{SwapCallbackError as Fe,SwapShowAcceptChanges as Ye}from"./styled-Cb09-IEr.js";import{Trace_default as He}from"./Trace-DgHN3Ak9.js";import{V2_DEFAULT_FEE_TIER as ze}from"./pools-5GjP-hMy.js";import{AutoRow as Qe,RowBetween as Ve}from"./Row-D0lmZ56K.js";import{useInterval as Ke}from"./useInterval-7f86mkEJ.js";import{useRouterPreference as Xe,useUserSlippageTolerance as Ze}from"./hooks-ViKlw47o.js";import{useRevokeTokenAllowance as $e,useTokenAllowance as Je,useTriggerOnTransactionType as et,useUpdateTokenAllowance as tt}from"./useTokenAllowance-B1d-BbCj.js";import{SwapLineItemType as R,SwapLineItem_default as D}from"./SwapLineItem-CkeBjgN3.js";var i=C(pe());const nt=({title:e,titleId:o,...t},s)=>i.createElement("svg",{width:17,height:16,viewBox:"0 0 17 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",ref:s,"aria-labelledby":o,...t},e?i.createElement("title",{id:o},e):null,i.createElement("path",{d:"M11.6376 8.86202C11.8982 9.12269 11.8982 9.54407 11.6376 9.80473L8.97089 12.4714C8.84089 12.6014 8.6702 12.6667 8.49954 12.6667C8.32887 12.6667 8.15818 12.6014 8.02818 12.4714L5.36152 9.80473C5.10085 9.54407 5.10085 9.12269 5.36152 8.86202C5.62218 8.60136 6.04356 8.60136 6.30422 8.86202L8.49954 11.0573L10.6948 8.86202C10.9555 8.60136 11.3769 8.60136 11.6376 8.86202ZM6.30422 7.13807L8.49954 4.94275L10.6948 7.13807C10.8248 7.26807 10.9955 7.33338 11.1662 7.33338C11.3369 7.33338 11.5076 7.26807 11.6376 7.13807C11.8982 6.8774 11.8982 6.45602 11.6376 6.19536L8.97089 3.52869C8.71022 3.26802 8.28885 3.26802 8.02818 3.52869L5.36152 6.19536C5.10085 6.45602 5.10085 6.8774 5.36152 7.13807C5.62218 7.39873 6.04356 7.39873 6.30422 7.13807Z",fill:"#5E5E5E"})),ot=(0,i.forwardRef)(nt),rt=({title:e,titleId:o,...t},s)=>i.createElement("svg",{width:16,height:16,viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",ref:s,"aria-labelledby":o,...t},e?i.createElement("title",{id:o},e):null,i.createElement("path",{d:"M11.1376 11.5287C11.3982 11.7894 11.3982 12.2107 11.1376 12.4714C11.0076 12.6014 10.8369 12.6667 10.6662 12.6667C10.4955 12.6667 10.3248 12.6014 10.1948 12.4714L7.99954 10.2761L5.80422 12.4714C5.54356 12.7321 5.12218 12.7321 4.86152 12.4714C4.60085 12.2107 4.60085 11.7894 4.86152 11.5287L7.52818 8.86202C7.78885 8.60136 8.21022 8.60136 8.47089 8.86202L11.1376 11.5287ZM7.52818 7.13807C7.65818 7.26807 7.82887 7.33338 7.99954 7.33338C8.1702 7.33338 8.34089 7.26807 8.47089 7.13807L11.1376 4.4714C11.3982 4.21073 11.3982 3.78936 11.1376 3.52869C10.8769 3.26802 10.4555 3.26802 10.1948 3.52869L7.99954 5.724L5.80422 3.52869C5.54356 3.26802 5.12218 3.26802 4.86152 3.52869C4.60085 3.78936 4.60085 4.21073 4.86152 4.4714L7.52818 7.13807Z",fill:"#5E5E5E"})),it=(0,i.forwardRef)(rt),st=[{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"address",name:"",type:"address"},{internalType:"address",name:"",type:"address"}],name:"allowance",outputs:[{internalType:"uint160",name:"amount",type:"uint160"},{internalType:"uint48",name:"expiration",type:"uint48"},{internalType:"uint48",name:"nonce",type:"uint48"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"wordPos",type:"uint256"},{internalType:"uint256",name:"mask",type:"uint256"}],name:"invalidateUnorderedNonces",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"},{internalType:"address",name:"spender",type:"address"},{internalType:"uint160",name:"amount",type:"uint160"},{internalType:"uint48",name:"expiration",type:"uint48"}],name:"approve",outputs:[],stateMutability:"nonpayable",type:"function"}];var N=C(oe());ne();var se=C(we());const at=(0,se.default)("30d"),ct=(0,se.default)("30m");function te(e){return Math.floor((Date.now()+e)/1e3)}function pt({token:e,owner:o,spender:t}){const s=!!o&&!!(e!=null&&e.address)&&!!t,{data:n,refetch:l}=Ie({address:P((0,N.permit2Address)(e==null?void 0:e.chainId)),abi:st,chainId:e==null?void 0:e.chainId,functionName:"allowance",args:s?[P(o),P(e.address),P(t)]:void 0,query:{enabled:s}});return et(Ce.Swap,l),(0,i.useMemo)(()=>{if(!n)return{permitAllowance:void 0,expiration:void 0,nonce:void 0};const[a,f,c]=n;return{permitAllowance:e?me.fromRawAmount(e,a.toString()):void 0,expiration:f,nonce:c}},[n,e])}function ut({token:e,spender:o,nonce:t,onPermitSignature:s}){const n=ie(),l=Oe(),a=(0,i.useRef)(n);a.current=n;const f=(0,i.useRef)(l);return f.current=l,(0,i.useCallback)(async()=>{try{const c=a.current;if(c.status!=="connected")throw new Error("wallet not connected");if(!c.chainId)throw new Error("connected to an unsupported network");if(!e)throw new Error("missing token");if(!o)throw new Error("missing spender");if(t===void 0)throw new Error("missing nonce");const p={details:{token:e.address,amount:N.MaxAllowanceTransferAmount,expiration:te(at),nonce:t},spender:o,sigDeadline:te(ct)},{domain:u,types:h,values:y}=N.AllowanceTransfer.getPermitData(p,(0,N.permit2Address)(e.chainId),c.chainId),m=await(async()=>{try{const d=f.current;if(!d)throw new Error("missing signer");return await Pe({signer:d,domain:u,types:h,value:y})}catch(d){if(De(d)){const v=e.symbol??"Token";throw new ee(`${v} permit allowance failed: User rejected signature`)}else throw d}})();s({...p,signature:m});return}catch(c){if(c instanceof ee)throw c;{const p=(e==null?void 0:e.symbol)??"Token";throw Re(`${p} permit allowance failed:`,c)}}},[t,s,o,e])}var lt=C(oe()),x=(function(e){return e[e.PENDING=0]="PENDING",e[e.SYNCING=1]="SYNCING",e[e.SYNCED=2]="SYNCED",e})(x||{});let A=(function(e){return e[e.LOADING=0]="LOADING",e[e.REQUIRED=1]="REQUIRED",e[e.ALLOWED=2]="ALLOWED",e})({});function un({amount:e,spender:o,tradeFillType:t}){const s=ie(),n=e==null?void 0:e.currency,l=(0,lt.permit2Address)(n==null?void 0:n.chainId),{tokenAllowance:a,isSyncing:f}=Je({token:n,owner:s.address,spender:l}),c=tt(e,l),p=$e(n,l),u=(0,i.useMemo)(()=>!e||!a?!1:a.greaterThan(e)||a.equalTo(e),[e,a]),[h,y]=(0,i.useState)(x.SYNCED),m=h!==x.SYNCED,d=Ue(n,l),v=Me(n,l);(0,i.useEffect)(()=>{y(d?x.PENDING:g=>g===x.PENDING&&f?x.SYNCING:g===x.SYNCING&&!f?x.SYNCED:g)},[d,f]);const[w,M]=(0,i.useState)(Date.now()+Y);Ke((0,i.useCallback)(()=>M((Date.now()+Y)/1e3),[]),Y);const[_,ae]=(0,i.useState)(),B=(0,i.useMemo)(()=>!e||!_?!1:_.details.token===(n==null?void 0:n.address)&&_.spender===o&&_.sigDeadline>=w,[e,w,_,o,n==null?void 0:n.address]),{permitAllowance:b,expiration:O,nonce:ce}=pt({token:n,owner:s.address,spender:o}),S=ut({token:n,spender:o,nonce:ce,onPermitSignature:ae}),G=(0,i.useMemo)(()=>!e||!b||!O?!1:(b.greaterThan(e)||b.equalTo(e))&&O>=w,[e,w,b,O]),V=!(u||m),E=t===re.Classic&&!(G||B),T=Be(),q=(0,i.useCallback)(async()=>{if(V){const{response:g,info:I}=await c();T(g,I)}E&&await S()},[T,V,E,S,c]),W=(0,i.useCallback)(async()=>{const{response:g,info:I}=await c();T(g,I)},[T,c]),F=(0,i.useCallback)(async()=>{const{response:g,info:I}=await p();T(g,I)},[T,p]);return(0,i.useMemo)(()=>{if(n){if(!a||!b)return{state:A.LOADING};if(E)return{token:n,state:A.REQUIRED,isApprovalLoading:!1,isApprovalPending:d,isRevocationPending:v,approveAndPermit:q,approve:W,permit:S,revoke:F,needsSetupApproval:!u,needsPermitSignature:E,allowedAmount:a};if(!u)return{token:n,state:A.REQUIRED,isApprovalLoading:m,isApprovalPending:d,isRevocationPending:v,approveAndPermit:q,approve:W,permit:S,revoke:F,needsSetupApproval:!0,needsPermitSignature:E,allowedAmount:a}}return{token:n,state:A.ALLOWED,permitSignature:!G&&B?_:void 0,needsSetupApproval:!1,needsPermitSignature:!1}},[W,q,m,d,u,G,B,S,b,F,v,E,_,n,a])}var z=C(he());ne();xe();ge();function mt(e){return e.swaps.map(({route:{path:o,pools:t,protocol:s},inputAmount:n,outputAmount:l})=>{const a=e.tradeType===fe.EXACT_INPUT?n.divide(e.inputAmount):l.divide(e.outputAmount),f=new de(a.numerator,a.denominator),c=[];for(let p=0;p<t.length;p++){const u=t[p],h=o[p],y=o[p+1],m=u instanceof Z?z.Protocol.V2:u instanceof ye?z.Protocol.V3:z.Protocol.V4,d=[h,y,u instanceof Z?ze:u.fee,m];c.push(d)}return{percent:f,path:c,protocol:s}})}const dt=e=>{if(!e)return{};const o={routes_percentages:[],routes_protocols:[]};return e.forEach((t,s)=>{o.routes_percentages.push(be(t.percent)),o.routes_protocols.push(t.protocol),o[`route_${s}_input_currency_symbols`]=t.path.map(n=>n[0].symbol??""),o[`route_${s}_output_currency_symbols`]=t.path.map(n=>n[1].symbol??""),o[`route_${s}_input_currency_addresses`]=t.path.map(n=>k(n[0])),o[`route_${s}_output_currency_addresses`]=t.path.map(n=>k(n[1])),o[`route_${s}_fee_amounts_hundredths_of_bps`]=t.path.map(n=>n[2])}),o};function ln({trade:e,priceUpdate:o,response:t}){return{chain_id:e.inputAmount.currency.chainId===e.outputAmount.currency.chainId?e.inputAmount.currency.chainId:void 0,response:t,token_in_symbol:e.inputAmount.currency.symbol,token_out_symbol:e.outputAmount.currency.symbol,price_update_basis_points:o}}const ft=({trade:e,inputCurrency:o,swapResult:t,allowedSlippage:s,transactionDeadlineSecondsSinceEpoch:n,isAutoSlippage:l,isAutoRouterApi:a,routes:f,fiatValueInput:c,fiatValueOutput:p})=>{var u;const h=o??e.inputAmount.currency;return{estimated_network_fee_usd:L(e)?(u=e.gasUseEstimateUSD)===null||u===void 0?void 0:u.toString():void 0,transaction_hash:(t==null?void 0:t.type)===re.Classic?t.response.hash:void 0,order_hash:Te(t==null?void 0:t.type)?t.response.orderHash:void 0,transaction_deadline_seconds:Ee(n),token_in_address:k(h),token_out_address:k(e.outputAmount.currency),token_in_symbol:h.symbol,token_out_symbol:e.outputAmount.currency.symbol,token_in_amount:J(e.inputAmount,e.inputAmount.currency.decimals),token_out_amount:J(e.outputAmount,e.outputAmount.currency.decimals),token_in_amount_usd:c,token_out_amount_usd:p,price_impact_basis_points:L(e)?$(je(e)):void 0,allowed_slippage_basis_points:$(s),is_auto_router_api:a,is_auto_slippage:l,transactionOriginType:Ae.Internal,chain_id:e.inputAmount.currency.chainId===e.outputAmount.currency.chainId?e.inputAmount.currency.chainId:void 0,swap_quote_block_number:L(e)?e.blockNumber??void 0:void 0,...dt(f)}};var r=C(le());const _t="  _display-flex _alignItems-stretch _flexBasis-auto _boxSizing-border-box _position-relative _minHeight-0px _minWidth-0px _flexShrink-0 _flexDirection-column ",ht="  _display-flex _alignItems-stretch _flexBasis-auto _boxSizing-border-box _position-relative _minHeight-0px _minWidth-0px _flexShrink-0 _flexDirection-row _gap-t-space-gap56 ",Q="  is_Separator _display-flex _alignItems-stretch _flexDirection-column _flexBasis-auto _boxSizing-border-box _position-relative _minHeight-0px _minWidth-0px _borderTopColor-surface3 _borderRightColor-surface3 _borderBottomColor-surface3 _borderLeftColor-surface3 _flexShrink-1 _borderTopWidth-0px _borderRightWidth-0px _borderBottomWidth-1px _borderLeftWidth-0px _flexGrow-1 _height-0px _maxHeight-0px _borderBottomStyle-solid _borderTopStyle-solid _borderLeftStyle-solid _borderRightStyle-solid ",yt=U(We)`
  padding: 0px 12px 8px;
`,gt=U.div`
  display: flex;
  align-items: center;
  margin-right: -6px;

  padding: 0 16px;
  min-width: fit-content;
  white-space: nowrap;
`,xt=U.button`
  padding: 0px 16px;
  margin-top: 4px;
  margin-bottom: 4px;
  height: 28px;
  text-decoration: none;
  display: flex;
  background: none;
  border: none;
  align-items: center;
  cursor: pointer;
`,vt=U(qe)`
  width: 100%;
  text-align: center;
  margin-top: 16px;
  margin-bottom: 4px;
`;function mn({open:e,onClick:o,children:t}){return(0,r.jsxs)(xt,{onClick:o,children:[(0,r.jsx)("div",{className:Q}),(0,r.jsxs)(gt,{children:[(0,r.jsx)(Ge.BodySmall,{color:"neutral2",children:t||(e?(0,r.jsx)(j,{i18nKey:"common.showLess.button"}):(0,r.jsx)(j,{i18nKey:"common.showMore.button"}))}),e?(0,r.jsx)(it,{}):(0,r.jsx)(ot,{})]}),(0,r.jsx)("div",{className:Q})]})}function dn({trade:e,inputCurrency:o,allowance:t,allowedSlippage:s,swapResult:n,onConfirm:l,swapErrorMessage:a,disabledConfirm:f,fiatValueInput:c,fiatValueOutput:p,showAcceptChanges:u,onAcceptChanges:h,isLoading:y}){const{t:m}=ue(),d=Ze()[0]==="auto",[v]=Xe(),w=L(e)?mt(e):void 0,M=Se(),_=(0,i.useMemo)(()=>t&&t.state===A.REQUIRED&&t.needsSetupApproval?{buttonText:H(e)?m("swap.approveAndSubmit"):m("swap.approveAndSwap")}:t&&t.state===A.REQUIRED&&t.needsPermitSignature?{buttonText:m("swap.signAndSwap")}:{buttonText:H(e)?m("swap.placeOrder"):m("swap.confirmSwap")},[t,m,e]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(yt,{gap:"sm",children:H(e)?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:Q}),(0,r.jsx)(wt,{trade:e})]}):null}),u?(0,r.jsx)(Ye,{"data-testid":"show-accept-changes",children:(0,r.jsxs)(Ve,{children:[(0,r.jsxs)("div",{className:ht,children:[(0,r.jsx)(Ne,{size:20,color:"$accent1"}),(0,r.jsx)(Le,{variant:"body2",color:"$accent1",children:(0,r.jsx)(j,{i18nKey:"common.priceUpdated"})})]}),(0,r.jsx)("div",{className:_t,children:(0,r.jsx)(K,{size:"small",variant:"branded",onPress:h,children:(0,r.jsx)(j,{i18nKey:"common.accept"})})})]})}):(0,r.jsxs)(Qe,{children:[(0,r.jsxs)(He,{logPress:!0,element:X.ConfirmSwapButton,eventOnTrigger:_e.SwapSubmittedButtonClicked,properties:{...ft({trade:e,inputCurrency:o,swapResult:n,allowedSlippage:s,isAutoSlippage:d,isAutoRouterApi:v===ve.API,routes:w,fiatValueInput:c.data,fiatValueOutput:p.data}),...M},children:[(0,r.jsx)(K,{variant:"branded","data-testid":"confirm-swap-button",loading:y,onPress:l,isDisabled:f,id:X.ConfirmSwapButton,children:y?m("swap.finalizingQuote"):_.buttonText}),_.helpLink&&(0,r.jsx)(vt,{href:_.helpLink.url,children:_.helpLink.text})]}),a?(0,r.jsx)(Fe,{error:a}):null]})]})}function wt({trade:e}){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(D,{trade:e,type:R.EXCHANGE_RATE}),(0,r.jsx)(D,{trade:e,type:R.EXPIRY}),(0,r.jsx)(D,{trade:e,type:R.SWAP_FEE}),(0,r.jsx)(D,{trade:e,type:R.NETWORK_COST}),(0,r.jsx)(ke,{})]})}export{A as AllowanceState,mn as DropdownController,dn as SwapDetails,ln as formatSwapPriceUpdatedEventProperties,un as usePermit2Allowance};
