import{__toESM as S}from"./chunk-DgAfPHQg.js";import{require_react as Y}from"./react-CNoFhWkx.js";import{isExtension as Z}from"./index.web-BqgtOHN3.js";import{useDispatch as tt}from"./es-Iwj7vF3u.js";import{ReactQueryCacheKey as et}from"./cache-BFZkIToX.js";import{require_jsx_runtime as nt}from"./jsx-runtime-D7bMTQeG.js";import{useEnabledChains as rt}from"./useEnabledChains-DuB86c95.js";import{getLogger as ot,isTestEnv as st,useEvent as I,usePrevious as it}from"./hooks-BXO4d1DJ.js";import{skipToken as P}from"./api-BsCrUy1C.js";import{CurrencyAmount as Q,NetworkStatus as at,Price as b,TradeType as k,UniverseChainId as E,getChainInfo as ut,getPrimaryStablecoin as U,init_sdk_core_esm as V,toGraphQLChain as ct,useTokenSpotPriceQuery as dt}from"./utils-BX1Fu73x.js";import{useQuery as j,useQueryClient as R}from"./useQuery-D_ZCw8XG.js";import{ClassicTrade as X,INTERNAL_ROUTER_PREFERENCE_PRICE as T,QuoteState as lt,RouterPreference as mt,TradeState as g,URAQuoteType as O}from"./types-DbOmsKtk.js";import{require_ms as ft}from"./ms-BqmEYo6j.js";import{FeatureFlags as D,useFeatureFlag as q}from"./hooks-Bp0VtWbX.js";import{AVERAGE_L1_BLOCK_TIME_MS as ht}from"./usePollingIntervalByChain-YBOfXXzb.js";import{nativeOnChain as w}from"./objects-DlLkJwrJ.js";import{currencyAddressForSwapQuote as x}from"./analytics-Ccvj1WVk.js";import{useUniswapXPriorityOrderFlag as G}from"./TradingApiClient-Cp_0ez5S.js";import{useMutation as vt}from"./connector-Cw8HJLtm.js";import{queryOptions as pt}from"./queryOptions-P48mrm5X.js";import{NumberType as N}from"./types-JuyYLR0O.js";import{useLocalizationContext as gt}from"./LocalizationContext-B31peW1_.js";import{useIsSupportedChainId as yt,useSupportedChainId as H}from"./useSupportedChainId-DskHoisQ.js";import{useGetQuoteQuery as It,useGetQuoteQueryState as Ct}from"./queryOptions-Dj3qRbwo.js";import{useAccountEffect as Ot}from"./useAccountEffect-CHrs5vTR.js";import{setHasShownMismatchToast as At}from"./slice-DoLbOto3.js";import{PollingInterval as Mt,getNativeTokenDBAddress as Pt}from"./util-BZ6kLG7e.js";import{useIsWindowVisible as K}from"./useIsWindowVisible-CtuFA8fK.js";import{styled_components_default as B}from"./styled-components-DbVO3u5J.js";import{ThemedText as _}from"./text-CK4eXdYc.js";import{tryParseCurrencyAmount as bt}from"./tryParseCurrencyAmount-Bt3FPZDG.js";const Et=t=>e=>pt({queryKey:[et.MismatchAccountBulk,e.address,e.chainIds,t.isMainnet],queryFn:async()=>{if(!e.address||!e.chainIds.length)return Object.fromEntries(e.chainIds.map(o=>[String(o),!1]));const r=await t.hasMismatch({address:e.address,chainIds:e.chainIds});return Object.fromEntries(e.chainIds.map(o=>[String(o),r[String(o)]??!1]))},enabled:!!e.address&&e.chainIds.length>0,refetchInterval:!1,refetchOnWindowFocus:!0,refetchOnMount:!0,refetchOnReconnect:!1,retry:!1});var m=S(Y());function Tt(t){const{defaultChainId:e}=C(),r=(t==null?void 0:t.chainId)??e,n=A(),o=I(i=>(i==null?void 0:i[String(r)])??!1);return j({...n,select:o})}function Se(){const t=A(),e=I(n=>{if(!n)return!1;for(const o in n)if(n[o])return!0;return!1}),{data:r}=j({...t,select:e});return r??!1}function ke(){const t=A(),e=R();return I(r=>{const n=e.getQueryData(t.queryKey);if(!n)return!1;if(!r){for(const o in n)if(n[o])return!0;return!1}return n[String(r)]??!1})}function wt(){const{account:t}=C(),e=A(),r=R();(0,m.useEffect)(()=>{!t.address||!t.chainId||r.invalidateQueries({queryKey:e.queryKey}).catch(()=>{})},[t.address,t.chainId,e.queryKey,r])}function St(){const{account:t,onHasAnyMismatch:e,isTestnetModeEnabled:r}=C(),n=r?"testnet":"mainnet",o=it(n),{mutate:i,isPending:u,isSuccess:a,isError:d}=kt({onHasAnyMismatch:e}),l=(0,m.useRef)(void 0),h=I(()=>{u||a||d||i()});(0,m.useEffect)(()=>{if(o!==n){h();return}},[n,o,h]),(0,m.useEffect)(()=>{t.address&&t.address!==l.current&&(h(),l.current=t.address)},[t.address,h])}const kt=t=>{const{account:e}=C(),r=A(),n=R(),o=ot();return vt({retry:(i,u)=>{switch(Rt(u)){case"retry":return!0;case"noRetry":return!1;default:return i<3}},mutationFn:async()=>e.address?n.fetchQuery({...r,staleTime:0}):{},onSuccess:i=>{if(!e.address)return;let u=!1;for(const a in i)i[String(a)]&&(u=!0,o.info("useMismatchAccount.ts","useAllAcountChainMismatchMutation",`mismatch found on chain ${a}`));u&&t.onHasAnyMismatch()}})};function Rt(t){const e=t.message,r=e?Object.keys(F).find(o=>e.toLowerCase().includes(o.toLowerCase())):void 0,n=r?F[r]:void 0;return n?n.retry?"retry":"noRetry":"unknown"}const F={UnknownRPCError:{retry:!1},"Not implemented":{retry:!1}};function A(){const{isTestnetModeEnabled:t,mismatchCallback:e,account:r,chains:n}=C();return(0,m.useMemo)(()=>Et({hasMismatch:e,isMainnet:!t})({address:r.address,chainIds:n}),[r.address,n,t,e])}function Dt(){const t=tt(),e=I(()=>{t(At(!1))}),r=(0,m.useMemo)(()=>({onConnect:e,onDisconnect:e}),[e]);Ot(r)}const qt=Z?()=>{}:Dt;var y=S(nt());const W=m.memo(()=>(St(),wt(),null));W.displayName="MismatchAccountEffects";const Lt=()=>{const t=C().account;return qt(),!t.address||st()?null:(0,y.jsx)(W,{})},J=(0,m.createContext)(void 0),Ut=m.memo(function({children:e,mismatchCallback:r,address:n,chainId:o,onHasAnyMismatch:i,chains:u,defaultChainId:a,isTestnetModeEnabled:d}){const l=xt(),h=I(async c=>l?{[String(o)]:!0}:r(c)),f=(0,m.useMemo)(()=>({mismatchCallback:h,account:{address:n,chainId:o},onHasAnyMismatch:i,chains:u,defaultChainId:a,isTestnetModeEnabled:d}),[h,n,o,i,u,a,d]);return(0,y.jsxs)(J.Provider,{value:f,children:[(0,y.jsx)(Lt,{}),e]})});Ut.displayName="MismatchContextProvider";function C(){const t=(0,m.useContext)(J);if(!t)throw new Error("MismatchContext not found");return t}function xt(){return q(D.ForcePermitTransactions)}let Nt=(function(t){return t.Short="short",t.Long="long",t})({});function Re({timestamp:t,includeYear:e=!1,type:r}){const n=r===Nt.Long?{month:"long",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0,year:e?"numeric":void 0}:{year:e?"2-digit":void 0,month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};return new Intl.DateTimeFormat("en-US",n).format(t)}function _t(t){const e=q(D.ArbitrumDutchV3),r=G(t);return t===E.Mainnet||e&&t===E.ArbitrumOne||r}function Ft(t){const{canUseUniswapX:e,isPriorityOrdersEnabled:r,isDutchV3Enabled:n}=t;return function(i){if(!z(i))throw new Error(`Invalid routing API input: ${JSON.stringify(i)}`);const{account:u,tokenIn:a,tokenOut:d,amount:l,tradeType:h,routerPreference:f,protocolPreferences:c}=i,v=f!==T,s=f===mt.X&&r,p=a.chainId===E.ArbitrumOne,M=Qt({canUseUniswapX:e,isPriorityOrder:s,isArbitrum:p,isDutchV3Enabled:n});return{account:u,amount:l.quotient.toString(),tokenInAddress:x(a),tokenInChainId:a.chainId,tokenInDecimals:a.wrapped.decimals,tokenInSymbol:a.wrapped.symbol,tokenOutAddress:x(d),tokenOutChainId:d.wrapped.chainId,tokenOutDecimals:d.wrapped.decimals,tokenOutSymbol:d.wrapped.symbol,routerPreference:f,protocolPreferences:c,tradeType:h,needsWrapIfUniswapX:a.isNative,uniswapXForceSyntheticQuotes:!1,sendPortionEnabled:v,routingType:M}}}function z(t){return!!t.tokenIn&&!!t.tokenOut&&!!t.amount&&!t.tokenIn.equals(t.tokenOut)&&!t.tokenIn.wrapped.equals(t.tokenOut.wrapped)}function Qt(t){const{canUseUniswapX:e,isPriorityOrder:r,isArbitrum:n,isDutchV3Enabled:o}=t;return e?r?O.PRIORITY:n?o?O.DUTCH_V3:O.DUTCH_V1:O.DUTCH_V2:O.CLASSIC}function Vt(t){var e,r,n;const o=_t((e=t.tokenIn)===null||e===void 0?void 0:e.chainId),i=G((r=t.tokenIn)===null||r===void 0?void 0:r.chainId),u=q(D.ArbitrumDutchV3),{data:a}=Tt({chainId:(n=t.tokenIn)===null||n===void 0?void 0:n.chainId}),d=o&&!a,l=(0,m.useMemo)(()=>Ft({canUseUniswapX:d,isPriorityOrdersEnabled:i,isDutchV3Enabled:u}),[d,i,u]),{tokenIn:h,tokenOut:f,amount:c,account:v,routerPreference:s,protocolPreferences:p,tradeType:M}=t,L=z(t);return(0,m.useMemo)(()=>L?l({account:v,tokenIn:h,tokenOut:f,amount:c,tradeType:M,routerPreference:s,protocolPreferences:p}):P,[l,h,f,c,v,s,p,M,L])}V();var jt=S(ft());const Xt={state:g.NO_ROUTE_FOUND,trade:void 0,currentData:void 0},Gt={state:g.LOADING,trade:void 0,currentData:void 0};function $(t=!1,e,r,n,o,i,u){const[a,d]=(0,m.useMemo)(()=>e===k.EXACT_INPUT?[r==null?void 0:r.currency,n]:[n,r==null?void 0:r.currency],[r,n,e]),l=Vt({account:i,tokenIn:a,tokenOut:d,amount:r,tradeType:e,routerPreference:o,protocolPreferences:u}),h=K(),{isError:f,data:c,error:v,currentData:s}=Ct(l);It(t||!h?P:l,{pollingInterval:o===T?(0,jt.default)("1m"):ht,refetchOnMountOrArgChange:120});const p=s!==c||!s;return(0,m.useMemo)(()=>r&&n&&l===P?{state:g.STALE,trade:c==null?void 0:c.trade,currentTrade:s==null?void 0:s.trade}:!r||f||l===P?{state:g.INVALID,trade:void 0,currentTrade:s==null?void 0:s.trade,error:JSON.stringify(v)}:(c==null?void 0:c.state)===lt.NOT_FOUND&&!p?Xt:c!=null&&c.trade?{state:p?g.LOADING:g.VALID,trade:c.trade,currentTrade:s==null?void 0:s.trade}:Gt,[r,v,f,p,l,c==null?void 0:c.state,c==null?void 0:c.trade,s==null?void 0:s.trade,n])}V();function Ht(t){return Q.fromRawAmount(w(t),t===E.Mainnet?5e19:1e19)}function Kt(t){const e=t==null?void 0:t.chainId,n=yt(e)&&t,o=n?Ht(e):void 0,{trade:i,state:u}=$(!n,k.EXACT_OUTPUT,o,t,T);return(0,m.useMemo)(()=>{if(!n)return{data:void 0,isLoading:!1};if(t.wrapped.equals(w(e).wrapped))return{data:new b(t,t,"1","1"),isLoading:!1};if(!i||u===g.LOADING)return{data:void 0,isLoading:u===g.LOADING};if(i instanceof X){const{numerator:a,denominator:d}=i.routes[0].midPrice;return{data:new b(t,w(e),d,a),isLoading:!1}}return{data:void 0,isLoading:!1}},[e,t,n,u,i])}const Bt=1e4;function Wt(t){const e=ut(t);if(e.spotPriceStablecoinAmountOverride)return e.spotPriceStablecoinAmountOverride;const r=Bt*Math.pow(10,U(t).decimals);return Q.fromRawAmount(U(t),r)}function Jt(t){const e=H(t==null?void 0:t.chainId),r=(0,m.useMemo)(()=>e?Wt(e):void 0,[e]),n=r==null?void 0:r.currency,{trade:o,state:i}=$(!1,k.EXACT_OUTPUT,r,t,T),u=(0,m.useMemo)(()=>{if(!(!t||!n)){if(t.wrapped.equals(n))return new b(n,n,"1","1");if(o&&o instanceof X){const{numerator:d,denominator:l}=o.routes[0].midPrice;return new b(t,n,l,d)}}},[t,n,o]),a=(0,m.useRef)(u);return(!u||!a.current||!u.equalTo(a.current)||!u.baseCurrency.equals(a.current.baseCurrency))&&(a.current=u),{price:a.current,state:i}}function zt(t,e){var r;const n=(t==null?void 0:t.currency)??e,o=H(n==null?void 0:n.chainId),{defaultChainId:i}=rt(),u=ct(o??i),a=K(),{data:d,isLoading:l}=Kt(n),h=!!(d||l),{data:f,networkStatus:c}=dt({variables:{chain:u,address:Pt(u)},skip:!h||!a,pollInterval:Mt.Normal,notifyOnNetworkStatusChange:!0,fetchPolicy:"cache-first"}),{price:v}=Jt(h?void 0:n);return(0,m.useMemo)(()=>{if(t){if(v)return{data:parseFloat(v.quote(t).toSignificant()),isLoading:!1};{var s;const p=f==null||(s=f.token)===null||s===void 0||(s=s.project)===null||s===void 0||(s=s.markets)===null||s===void 0||(s=s[0])===null||s===void 0||(s=s.price)===null||s===void 0?void 0:s.value;return p&&d?{data:parseFloat(d.quote(t).toExact())*p,isLoading:!1}:{data:void 0,isLoading:l||c===at.loading}}}else return{data:void 0,isLoading:!1}},[t,f==null||(r=f.token)===null||r===void 0||(r=r.project)===null||r===void 0?void 0:r.markets,d,l,c,v])}const $t=B.button`
  background-color: transparent;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  grid-template-columns: 1fr auto;
  grid-gap: 0.25rem;
  display: flex;
  flex-direction: row;
  text-align: left;
  flex-wrap: wrap;
  user-select: text;
`;function De({price:t}){const{formatNumberOrString:e,convertFiatAmountFormatted:r}=gt(),[n,o]=(0,m.useState)(!1),{baseCurrency:i,quoteCurrency:u}=t,{data:a}=zt(bt("1",n?i:u)),d=(0,m.useMemo)(()=>{try{return e({value:(n?t:t.invert()).toSignificant(),type:N.TokenTx})}catch{return"0"}},[e,t,n]),l=n?`${t.quoteCurrency.symbol}`:`${t.baseCurrency.symbol} `,h=n?`${t.baseCurrency.symbol} `:`${t.quoteCurrency.symbol}`,f=(0,m.useCallback)(()=>o(!n),[o,n]),c=`${"1 "+h+" = "+d} ${l}`;return(0,y.jsxs)($t,{onClick:v=>{v.stopPropagation(),f()},title:c,children:[(0,y.jsx)(_.BodySmall,{children:c})," ",a&&(0,y.jsxs)(_.BodySmall,{color:"neutral2",children:["(",r(a,N.FiatTokenPrice),")"]})]})}const qe=B.div`
  width: 100%;
  height: 1px;
  border-width: 0;
  margin: 0;
  background-color: ${({theme:t})=>t.surface3};
`;export{qe as Divider,Nt as FormatType,Ut as MismatchContextProvider,De as TradePrice,Re as formatTimestamp,ke as useHasAccountMismatchCallback,Se as useHasAccountMismatchOnAnyChain,Tt as useIsMismatchAccountQuery,$ as useRoutingAPITrade,zt as useUSDPrice};
