import{__toESM as _}from"./chunk-DgAfPHQg.js";import{logger as g}from"./hooks-BXO4d1DJ.js";import{call as m,createSaga as W,getDisplayableError as w,handleApprovalTransactionStep as U,handleOnChainStep as H,handlePermitTransactionStep as j,handleSignatureStep as B,parseERC20ApproveCalldata as R}from"./utils-CK6a47NA.js";import{CurrencyAmount as Z,Fraction as z,Percent as G,Token as J,init_sdk_core_esm as E,invariant as K}from"./utils-BX1Fu73x.js";import{currencyId as I}from"./currencyId-Ci6selsx.js";import{LiquidityEventName as Q}from"./features-yACC1hVw.js";import{InterfaceEventName as S}from"./interface-BdpC4qOF.js";import{require_dist$1 as V}from"./V3DutchOrderTrade-Cl7yELmp.js";import{getSymbolDisplayText as F}from"./currency-DIOEzjz2.js";import{sendAnalyticsEvent as T}from"./send.web-CrSXW2rw.js";import{createLpPosition as X,increaseLpPosition as Y,migrateLpPosition as x}from"./TradingApiClient-Cp_0ez5S.js";import{TransactionType as v}from"./transactionDetails-BsNW_jus.js";import{NumberType as N}from"./types-JuyYLR0O.js";import{TransactionStepType as a}from"./types-7DAoWLTI.js";import{getLiquidityEventName as ee}from"./analytics-UE3_EENu.js";import{PopupType as te,popupRegistry as ne}from"./types-BSmAADNJ.js";import{AccountType as re}from"./types-NWGai6aQ.js";function ie(e){return{type:a.CollectFeesTransactionStep,txRequest:e}}function oe(e){return[e.collectFees]}function ae(e){const t=[];return e.approvalPositionToken&&t.push(e.approvalPositionToken),t.push(e.decreasePosition),t}function ce(e){return{type:a.DecreasePositionTransaction,txRequest:e}}function b(e){const t=[];return e.revokeToken0&&t.push(e.revokeToken0),e.revokeToken1&&t.push(e.revokeToken1),e.approvalToken0&&t.push(e.approvalToken0),e.approvalToken1&&t.push(e.approvalToken1),e.approvalPositionToken&&t.push(e.approvalPositionToken),e.permit&&t.push(e.permit),e.token0PermitTransaction&&t.push(e.token0PermitTransaction),e.token1PermitTransaction&&t.push(e.token1PermitTransaction),t.push(e.increasePosition),t}function je({calldataError:e,approvalError:t}){return e?P(e,{includeRequestId:!0})||!0:t?P(t,{includeRequestId:!0})||!0:!1}function P(e,{defaultTitle:t,includeRequestId:n}){var r,i;if(!e)return t;const o=e,c=(r=o.data)===null||r===void 0?void 0:r.requestId,u=((i=o.data)===null||i===void 0?void 0:i.detail)||o.name||t;return n&&u?`${u}, id: ${c}`:u}var se=_(V());E();function ue(e,t){const r=new z(se.ONE).subtract(pe).multiply(e.executionPrice);return t.executionPrice.lessThan(r)}const pe=new G(1,100);function Be(e,t){return!e||!t?!1:ue(e,t)?!0:e.tradeType!==t.tradeType||!e.inputAmount.currency.equals(t.inputAmount.currency)||!e.outputAmount.currency.equals(t.outputAmount.currency)}function Ze({usdAmountOut:e,outputCurrencyAmount:t,trade:n,showInverseRate:r,formatter:i}){const c=e&&t?parseFloat(e.toSignificant())/parseFloat(t.toSignificant()):null,u=c&&n?c*parseFloat(n.executionPrice.toSignificant()):null,p=r?c:u;return i.convertFiatAmountFormatted(p,N.FiatTokenPrice)}function ze({formatter:e,trade:t,showInverseRate:n}){const r=n?t.executionPrice.invert():t.executionPrice;let i;try{i=e.formatNumberOrString({value:r.toSignificant(),type:N.SwapPrice})}catch{i="0"}const o=F(t.executionPrice.quoteCurrency.symbol),c=F(t.executionPrice.baseCurrency.symbol),u=`1 ${o} = ${i} ${c}`,p=`1 ${c} = ${i} ${o}`;return n?u:p}function h(e){if(e!=null&&e.to&&e.chainId)return{...e,to:e.to,chainId:e.chainId}}function Ge(e){if(!(e!=null&&e.length))return;const t=[];for(const i of e){const o=h(i);if(!o)return;t.push(o)}const[n,...r]=t;return n?[n,...r]:void 0}function Je(e){const{domain:t,types:n,values:r}=e??{};if(t&&n&&r)return{domain:t,types:n,values:r}}function de(e){return{type:a.IncreasePositionTransaction,txRequest:e}}function me(e){return{type:a.IncreasePositionTransactionAsync,getTxRequest:async t=>{if(e)try{const{create:n}=await X({...e,signature:t,simulateTransaction:!0});return h(n)}catch(n){const r=P(n,{includeRequestId:!0});throw r&&(g.error(r,{tags:{file:"increasePosition",function:"createCreatePositionAsyncStep"}}),T(S.CreatePositionFailed,{message:r,...e})),n}}}}function ye(e){return{type:a.IncreasePositionTransactionAsync,getTxRequest:async t=>{if(e)try{const{increase:n}=await Y({...e,signature:t,simulateTransaction:!0});return h(n)}catch(n){const r=P(n,{includeRequestId:!0});throw r&&(g.error(r,{tags:{file:"generateTransactionSteps",function:"createIncreasePositionAsyncStep"}}),T(S.IncreaseLiquidityFailed,{message:r,...e})),n}}}}function le(e){return{type:a.MigratePositionTransaction,txRequest:e}}function fe(e,t){return{type:a.MigratePositionTransactionAsync,getTxRequest:async n=>{if(!(!e||!t))try{const{migrate:r}=await x({...e,signature:n,signatureDeadline:t,simulateTransaction:!0});return h(r)}catch(r){const i=P(r,{includeRequestId:!0});throw i&&(g.error(i,{tags:{file:"migrate.ts",function:"createMigratePositionAsyncStep"}}),T(S.MigrateLiquidityFailed,{message:i,...e})),r}}}}function D(e){const t=[];return e.permit&&t.push(e.permit),e.positionTokenPermitTransaction&&t.push(e.positionTokenPermitTransaction),t.push(e.migrate),t}let l=(function(e){return e.Create="create",e.Increase="increase",e.Decrease="decrease",e.Migrate="migrate",e.Collect="collect",e})({});function Te(e){return ve(e)!==void 0}function ve(e){if(!Pe(e))return;if(e.type===l.Collect)return e.txRequest?{...e,txRequest:e.txRequest}:void 0;const{action:t,txRequest:n,permit:r}=e,i=(e.type==="increase"||e.type==="create")&&e.unsigned;if(i)return r?{...e,action:t,unsigned:i,txRequest:void 0,permit:r}:void 0;if(n)return{...e,action:t,unsigned:i,txRequest:n,permit:void 0}}function Pe(e){return typeof e=="object"&&e!==null&&"action"in e&&"protocolVersion"in e}function A({txRequest:e,amountIn:t,pair:n}){if(!(e!=null&&e.data)||!t)return;const r=a.TokenApprovalTransaction,i=t.currency.wrapped,{spender:o}=R(e.data.toString()),c=t.quotient.toString();return{type:r,txRequest:e,token:i,spender:o,amount:c,pair:n}}function L(e,t){return{type:a.Permit2Signature,token:t,...e}}function q({txRequest:e,amountIn:t,pair:n}){if(!(e!=null&&e.data)||!t)return;const r=a.Permit2Transaction,i=t.currency.wrapped,{spender:o}=R(e.data.toString()),c=t.quotient.toString();return{type:r,txRequest:e,token:i,spender:o,amount:c,pair:n}}function M(e,t){if(!(e!=null&&e.data))return;const n=a.TokenRevocationTransaction,{spender:r,amount:i}=R(e.data.toString());if(i===BigInt(0))return{type:n,txRequest:e,token:t,spender:r,amount:"0"}}var ge=_(V());E();function Se(e){if(Te(e)){if(e.type===l.Collect)return oe({collectFees:ie(e.txRequest)});const{action:n,approveToken0Request:r,approveToken1Request:i,approvePositionTokenRequest:o,token0PermitTransaction:c,token1PermitTransaction:u,positionTokenPermitTransaction:p}=e,s=M(e.revokeToken0Request,n.currency0Amount.currency.wrapped),d=M(e.revokeToken1Request,n.currency1Amount.currency.wrapped),y=A({txRequest:r,amountIn:n.currency0Amount}),f=A({txRequest:i,amountIn:n.currency1Amount}),k=A({txRequest:o,amountIn:n.liquidityToken?Z.fromRawAmount(n.liquidityToken,1):void 0,pair:[n.currency0Amount.currency,n.currency1Amount.currency]}),$=q({txRequest:c,amountIn:n.currency0Amount,pair:[n.currency0Amount.currency,n.currency1Amount.currency]}),C=q({txRequest:u,amountIn:n.currency1Amount,pair:[n.currency0Amount.currency,n.currency1Amount.currency]}),O=q({txRequest:p,amountIn:n.currency1Amount,pair:[n.currency0Amount.currency,n.currency1Amount.currency]});switch(e.type){case"decrease":return ae({approvalPositionToken:k,decreasePosition:ce(e.txRequest)});case"migrate":return e.unsigned?D({permit:L(e.permit.typedData,new J(1,ge.ADDRESS_ZERO,1,"Uniswap V3 Positions NFT-V1","Uniswap V3 Positions NFT-V1")),migrate:fe(e.migratePositionRequestArgs,e.permit.typedData.values.deadline),positionTokenPermitTransaction:void 0}):D({permit:void 0,positionTokenPermitTransaction:O,migrate:le(e.txRequest)});case"create":case"increase":return e.unsigned?b({revokeToken0:s,revokeToken1:d,approvalToken0:y,approvalToken1:f,approvalPositionToken:k,permit:L(e.permit.typedData,n.currency0Amount.currency),token0PermitTransaction:void 0,token1PermitTransaction:void 0,increasePosition:e.type==="increase"?ye(e.increasePositionRequestArgs):me(e.createPositionRequestArgs)}):b({revokeToken0:s,revokeToken1:d,approvalToken0:y,approvalToken1:f,approvalPositionToken:k,permit:void 0,token0PermitTransaction:$,token1PermitTransaction:C,increasePosition:de(e.txRequest)})}}return[]}function*he(e,t){if(e.type===a.IncreasePositionTransaction||e.type===a.DecreasePositionTransaction||e.type===a.MigratePositionTransaction||e.type===a.CollectFeesTransactionStep)return e.txRequest;if(!t)throw new Error("Signature required for async increase position transaction step");const n=yield*m(e.getTxRequest,t);return K(n!==void 0,"txRequest must be defined"),n}function*ke(e){const{action:t,step:n,signature:r,analytics:i}=e,o=Re(t),c=yield*m(he,n,r),u=({hash:d,data:y})=>{var f;i&&T(Q.TransactionModifiedInWallet,{...i,transaction_hash:d,expected:(f=c.data)===null||f===void 0?void 0:f.toString(),actual:y})},p={...n,txRequest:c};let s;try{s=yield*m(H,{...e,info:o,step:p,shouldWaitForConfirmation:!1,onModification:u})}catch(d){throw i&&T(S.OnChainAddLiquidityFailed,{...i,message:d.message}),d}i&&T(ee(p.type),{...i,transaction_hash:s}),ne.addPopup({type:te.Transaction,hash:s},s)}function*Ae(e){const{account:t,setCurrentStep:n,steps:r,liquidityTxContext:{action:i},onSuccess:o,onFailure:c,analytics:u}=e;let p;for(const s of r)try{switch(s.type){case a.TokenRevocationTransaction:case a.TokenApprovalTransaction:{yield*m(U,{account:t,step:s,setCurrentStep:n});break}case a.Permit2Signature:{p=yield*m(B,{account:t,step:s,setCurrentStep:n});break}case a.Permit2Transaction:{yield*m(j,{account:t,step:s,setCurrentStep:n});break}case a.IncreasePositionTransaction:case a.IncreasePositionTransactionAsync:case a.DecreasePositionTransaction:case a.MigratePositionTransaction:case a.MigratePositionTransactionAsync:case a.CollectFeesTransactionStep:yield*m(ke,{account:t,step:s,setCurrentStep:n,action:i,signature:p,analytics:u});break;default:throw new Error("Unexpected step type")}}catch(d){const y=w({error:d,step:s,flow:"liquidity"});y?(g.error(y,{tags:{file:"liquiditySaga",function:"modifyLiquidity"}}),c(d)):c();return}yield*m(o)}function*qe(e){const{liquidityTxContext:t,startChainId:n,selectChain:r,onFailure:i}=e,o=yield*m(Se,t);e.setSteps(o);const c=t.action.currency0Amount.currency.chainId,u=t.action.currency1Amount.currency.chainId;if(c!==u){g.error("Tokens must be on the same chain",{tags:{file:"liquiditySaga",function:"liquidity"}}),i();return}if(c!==n&&!(yield*m(r,c))){i();return}return yield*Ae({...e,steps:o})}const Ke=W(qe,"liquiditySaga");function Re(e){let t;switch(e.type){case l.Create:t=v.CreatePool;break;case l.Increase:t=v.LiquidityIncrease;break;case l.Decrease:t=v.LiquidityDecrease;break;case l.Migrate:t=v.MigrateLiquidityV3ToV4;break;case l.Collect:t=v.CollectFees}const{currency0Amount:{currency:n,quotient:r},currency1Amount:{currency:i,quotient:o}}=e;return{type:t,currency0Id:I(n),currency1Id:I(i),currency0AmountRaw:r.toString(),currency1AmountRaw:o.toString()}}function Qe(e){return e.accountType===re.SignerMnemonic}export{l as LiquidityTransactionType,Ze as calculateRateLine,A as createApprovalTransactionStep,L as createPermit2SignatureStep,q as createPermit2TransactionStep,M as createRevocationTransactionStep,je as getErrorMessageToDisplay,ze as getRateToDisplay,Qe as isSignerMnemonicAccountDetails,Te as isValidLiquidityTxContext,Ke as liquiditySaga,P as parseErrorMessageTitle,Be as requireAcceptNewTrade,Je as validatePermit,h as validateTransactionRequest,Ge as validateTransactionRequests};
