import{__toESM as Q}from"./chunk-DgAfPHQg.js";import{logger as ne}from"./hooks-BXO4d1DJ.js";import{BIPS_BASE as oe,CurrencyAmount as k,Percent as X,Token as re,TradeType as ie,UniverseChainId as F,init_sdk_core_esm as M}from"./utils-BX1Fu73x.js";import{BigNumber as u,init_lib$5 as se}from"./lib-DPFIyRke.js";import{isEVMChain as ue}from"./currencyId-Ci6selsx.js";import{require_dist as ae,require_dist$1 as ce}from"./V3DutchOrderTrade-Cl7yELmp.js";import{Pool as me,Route as le,init_v3_sdk_esm as pe}from"./v3-sdk.esm-CHH6GWR1.js";import{Pair as de,Route as fe,init_v2_sdk_esm as _e}from"./v2-sdk.esm-CIiDMO7F.js";import{ClassicTrade as Ie,DutchOrderTrade as ve,OffchainOrderType as y,PoolType as x,PriorityOrderTrade as Te,QuoteMethod as Ae,QuoteState as q,RouterPreference as we,SwapRouterNativeAssets as h,TradeFillType as P,URAQuoteType as d,V2DutchOrderTrade as Ue,V3DutchOrderTrade as ge,isClassicQuoteResponse as ye}from"./types-DbOmsKtk.js";import{RPC_PROVIDERS as j}from"./providers-BELGpWsr.js";import{erc20_default as Se}from"./erc20-CdGGKIp0.js";import{getContract as K,weth_default as he}from"./getContract-CMwwszTa.js";import{WRAPPED_NATIVE_CURRENCY as Oe,nativeOnChain as W}from"./objects-DlLkJwrJ.js";import{BridgeTrade as qe,ClassicTrade as B,PriorityOrderTrade as Pe,UniswapXV2Trade as Ce,UniswapXV3Trade as Re}from"./TradingApiClient-Cp_0ez5S.js";import{Routing as N,isClassic as Ee}from"./selectors-BwkayGDl.js";import{getRouteAnalyticsData as Be,tradeRoutingToFillType as De}from"./useUSDCPrice-HO7Wgroz.js";import{TransactionOriginType as Fe}from"./transactionDetails-BsNW_jus.js";import{NATIVE_CHAIN_ID as ke}from"./tokens-Dxd89cHj.js";import{computeRealizedPriceImpact as be}from"./prices-BzyZhpWW.js";const yt="Unknown gas simulation error",Ne=45e3,St=1e3;var V=Q(ae());const Ve=65e3;async function Ge({account:e,currency:t,amount:n,usdCostPerGas:o}){if(t.isNative)return{needsApprove:!1};if(!e||!o)return{needsApprove:!1};if(t.chainId===F.ArbitrumOne)return{needsApprove:!1};const r=j[t.chainId],i=K({address:t.address,ABI:Se,provider:r});let a;try{if((await i.callStatic.allowance(e,(0,V.permit2Address)(t.chainId))).gte(n))return{needsApprove:!1}}catch{return{needsApprove:!1}}try{const s=await i.populateTransaction.approve((0,V.permit2Address)(t.chainId),V.MaxUint256);a=(await r.estimateGas({from:e,...s})).toNumber()}catch{a=Ve}return{needsApprove:!0,approveGasEstimateUSD:a*o}}async function xe({needsWrap:e,account:t,chainId:n,amount:o,usdCostPerGas:r}){var i;if(!e)return{needsWrap:!1};const a=j[n],s=(i=Oe[n])===null||i===void 0?void 0:i.address;if(!s||!r)return{needsWrap:!1};let m;try{const p=await K({address:s,ABI:he,provider:a,account:t}).populateTransaction.deposit({value:o});m=(await a.estimateGas({from:t,...p})).toNumber()}catch{m=Ne}return{needsWrap:!0,wrapGasEstimateUSD:m*r}}M();const Y=1e4,Xe=Y*100;function D(e){const t=Math.floor(Number(e)*Y);return new X(t,Xe)}se();var Me=Q(ce());M();_e();pe();function We(e,t){if(t.length===0)return[];const[n,o]=z({args:e,isUniswapXTrade:!1,routes:t});try{return t.map(r=>{if(r.length===0)throw new Error("Expected route to have at least one pair or pool");const i=r[0].amountIn,a=r[r.length-1].amountOut;if(!i||!a)throw new Error("Expected both amountIn and amountOut to be present");const s=L(x.V2Pool,r),m=L(x.V3Pool,r);return{routev3:m?new le(r.map(J),n,o):null,routev2:s?new fe(r.map(ee),n,o):null,mixedRoute:!m&&!s?new Me.MixedRouteSDK(r.map(Le),n,o):null,inputAmount:k.fromRawAmount(n,i),outputAmount:k.fromRawAmount(o,a)}})}catch(r){ne.warn("routing/utils","computeRoutes","Failed to compute routes",{error:r});return}}const Le=e=>e.type===x.V3Pool?J(e):ee(e);function L(e,t){return t.every(n=>n.type===e)}function He(e){const{nonce:t,input:n,outputs:o,exclusivityOverrideBps:r}=e;return{...e,nonce:u.from(t),exclusivityOverrideBps:u.from(r),input:{...n,startAmount:u.from(n.startAmount),endAmount:u.from(n.endAmount)},outputs:o.map(i=>({...i,startAmount:u.from(i.startAmount),endAmount:u.from(i.endAmount)}))}}function $e(e){const{nonce:t,input:n,outputs:o}=e;return{...e,nonce:u.from(t),input:{...n,startAmount:u.from(n.startAmount),endAmount:u.from(n.endAmount)},outputs:o.map(r=>({...r,startAmount:u.from(r.startAmount),endAmount:u.from(r.endAmount)}))}}function Qe(e){const{nonce:t,input:n,outputs:o,startingBaseFee:r}=e;return{...e,nonce:u.from(t),startingBaseFee:u.from(r),input:{...n,startAmount:u.from(n.startAmount),maxAmount:u.from(n.maxAmount),adjustmentPerGweiBaseFee:u.from(n.adjustmentPerGweiBaseFee),curve:{relativeBlocks:n.curve.relativeBlocks,relativeAmounts:n.curve.relativeAmounts.map(i=>u.from(i).toBigInt())}},outputs:o.map(i=>({...i,startAmount:u.from(i.startAmount),minAmount:u.from(i.minAmount),adjustmentPerGweiBaseFee:u.from(i.adjustmentPerGweiBaseFee),curve:{relativeBlocks:i.curve.relativeBlocks,relativeAmounts:i.curve.relativeAmounts.map(a=>u.from(a).toBigInt())}}))}}function je(e){const{nonce:t,auctionStartBlock:n,baselinePriorityFeeWei:o,input:r,outputs:i}=e;return{...e,nonce:u.from(t),auctionStartBlock:u.from(n),baselinePriorityFeeWei:u.from(o),input:{...r,amount:u.from(r.amount),mpsPerPriorityFeeWei:u.from(r.mpsPerPriorityFeeWei)},outputs:i.map(a=>({...a,amount:u.from(a.amount),mpsPerPriorityFeeWei:u.from(a.mpsPerPriorityFeeWei)}))}}function z({args:e,isUniswapXTrade:t,routes:n}){var o,r,i;const{tokenInAddress:a,tokenInChainId:s,tokenInDecimals:m,tokenInSymbol:w,tokenOutAddress:p,tokenOutChainId:U,tokenOutDecimals:R,tokenOutSymbol:b}=e,f=Object.values(h).includes(a),E=Object.values(h).includes(p),T=n==null||(o=n[0])===null||o===void 0||(o=o[0])===null||o===void 0?void 0:o.tokenIn,v=n==null||(r=n[0])===null||r===void 0||(r=r[((i=n[0])===null||i===void 0?void 0:i.length)-1])===null||r===void 0?void 0:r.tokenOut,_=f?W(s):O({address:a,chainId:s,decimals:m,symbol:w,buyFeeBps:T==null?void 0:T.buyFeeBps,sellFeeBps:T==null?void 0:T.sellFeeBps}),A=E?W(U):O({address:p,chainId:U,decimals:R,symbol:b,buyFeeBps:v==null?void 0:v.buyFeeBps,sellFeeBps:v==null?void 0:v.sellFeeBps});return t?[_.isNative?_.wrapped:_,A]:[_,A]}function Z(e){const{portionAmount:t,portionBips:n,portionRecipient:o}=e;if(!(!t||!n||!o))return{recipient:o,percent:new X(n,oe),amount:t}}function Ke(e,t){var n;const o=t.routing===d.CLASSIC?t.quote:(n=t.allQuotes.find(ye))===null||n===void 0?void 0:n.quote;return o?{gasUseEstimate:o.gasUseEstimate?parseFloat(o.gasUseEstimate):void 0,gasUseEstimateUSD:o.gasUseEstimateUSD?parseFloat(o.gasUseEstimateUSD):void 0,blockNumber:o.blockNumber,routes:We(e,o.route),swapFee:Z(o)}:{}}function Ye(e,t){if(!(!e||!t))return e/t}async function ht({args:e,data:t,quoteMethod:n}){const{tradeType:o,needsWrapIfUniswapX:r,routerPreference:i,account:a,amount:s,routingType:m}=e,w=(m===d.DUTCH_V2||m===d.DUTCH_V3||m===d.PRIORITY)&&i===we.X,[p,U]=z({args:e,isUniswapXTrade:w});if(!ue(p.chainId))throw new Error("chainId must be EVM for routing api paths");const{gasUseEstimateUSD:R,blockNumber:b,routes:f,gasUseEstimate:E,swapFee:T}=Ke(e,t),v=Ye(R,E),_=await Ge({account:a,currency:p,amount:s,usdCostPerGas:v}),A=new Ie({v2Routes:(f==null?void 0:f.filter(c=>c.routev2!==null).map(({routev2:c,inputAmount:I,outputAmount:l})=>({routev2:c,inputAmount:I,outputAmount:l})))??[],v3Routes:(f==null?void 0:f.filter(c=>c.routev3!==null).map(({routev3:c,inputAmount:I,outputAmount:l})=>({routev3:c,inputAmount:I,outputAmount:l})))??[],mixedRoutes:(f==null?void 0:f.filter(c=>c.mixedRoute!==null).map(({mixedRoute:c,inputAmount:I,outputAmount:l})=>({mixedRoute:c,inputAmount:I,outputAmount:l})))??[],tradeType:o,gasUseEstimateUSD:R,gasUseEstimate:E,approveInfo:_,blockNumber:b,requestId:t.quote.requestId,quoteMethod:n,swapFee:T});if(t.routing===d.DUTCH_V1||t.routing===d.DUTCH_V2||t.routing===d.DUTCH_V3||t.routing===d.PRIORITY){const c=Z(t.quote),I=await xe({needsWrap:r,account:a,chainId:p.chainId,amount:s,usdCostPerGas:v});if(t.routing===d.DUTCH_V3){const l=Qe(t.quote.orderInfo),g=new ge({currencyIn:p,currenciesOut:[U],orderInfo:l,tradeType:o,quoteId:t.quote.quoteId,requestId:t.quote.requestId,classicGasUseEstimateUSD:A.totalGasUseEstimateUSD,wrapInfo:I,approveInfo:_,deadlineBufferSecs:t.quote.deadlineBufferSecs,slippageTolerance:D(t.quote.slippageTolerance),swapFee:c});return{state:q.SUCCESS,trade:g}}else if(t.routing===d.DUTCH_V2){const l=$e(t.quote.orderInfo),g=new Ue({currencyIn:p,currenciesOut:[U],orderInfo:l,tradeType:o,quoteId:t.quote.quoteId,requestId:t.quote.requestId,classicGasUseEstimateUSD:A.totalGasUseEstimateUSD,wrapInfo:I,approveInfo:_,deadlineBufferSecs:t.quote.deadlineBufferSecs,slippageTolerance:D(t.quote.slippageTolerance),swapFee:c});return{state:q.SUCCESS,trade:g}}else if(t.routing===d.DUTCH_V1){const l=He(t.quote.orderInfo),g=new ve({currencyIn:p,currenciesOut:[U],orderInfo:l,tradeType:o,quoteId:t.quote.quoteId,requestId:t.quote.requestId,classicGasUseEstimateUSD:A.totalGasUseEstimateUSD,wrapInfo:I,approveInfo:_,auctionPeriodSecs:t.quote.auctionPeriodSecs,startTimeBufferSecs:t.quote.startTimeBufferSecs,deadlineBufferSecs:t.quote.deadlineBufferSecs,slippageTolerance:D(t.quote.slippageTolerance),swapFee:c});return{state:q.SUCCESS,trade:g}}else if(t.routing===d.PRIORITY){const l=je(t.quote.orderInfo),g=new Te({currencyIn:p,currenciesOut:[U],orderInfo:l,tradeType:o,approveInfo:_,wrapInfo:I,startTimeBufferSecs:t.quote.startTimeBufferSecs,deadlineBufferSecs:t.quote.deadlineBufferSecs,slippageTolerance:D(t.quote.slippageTolerance),classicGasUseEstimateUSD:A.totalGasUseEstimateUSD,swapFee:c,quoteId:t.quote.quoteId,requestId:t.quote.requestId});return{state:q.SUCCESS,trade:g}}}return{state:q.SUCCESS,trade:A}}function O({address:e,chainId:t,decimals:n,symbol:o,buyFeeBps:r,sellFeeBps:i}){const a=r?u.from(r):void 0,s=i?u.from(i):void 0;return new re(t,e,parseInt(n.toString()),o,void 0,!1,a,s)}function J({fee:e,sqrtRatioX96:t,liquidity:n,tickCurrent:o,tokenIn:r,tokenOut:i}){return new me(O(r),O(i),parseInt(e),t,n,parseInt(o))}const ee=({reserve0:e,reserve1:t})=>new de(k.fromRawAmount(O(e.token),e.quotient),k.fromRawAmount(O(t.token),t.quotient));function Ot(e){return e===ie.EXACT_INPUT}function qt(e){return e.isNative?e.chainId===F.Polygon?h.MATIC:e.chainId===F.Bnb?h.BNB:e.chainId===F.Avalanche?h.AVAX:h.ETH:e.address}function C(e){return(e==null?void 0:e.fillType)===P.Classic}function Pt(e){return(e==null?void 0:e.fillType)===P.None}function ze(e){return C(e)||S(e)}function Ze(e){return e===P.UniswapX||e===P.UniswapXv2||e===P.UniswapXv3}function S(e){return Ze(e==null?void 0:e.fillType)}function Ct(e){return S(e)&&(e.offchainOrderType===y.DUTCH_AUCTION||e.offchainOrderType===y.DUTCH_V2_AUCTION||e.offchainOrderType===y.DUTCH_V3_AUCTION||e.offchainOrderType===y.PRIORITY_ORDER)}function Rt(e){return S(e)&&e.offchainOrderType===y.LIMIT_ORDER}M();const Et=e=>{if(e)return e-new Date().getTime()/1e3},H=(e,t)=>parseFloat(e.toFixed(t)),$=e=>e.isNative?ke:e.address,te=e=>parseFloat(e.toFixed(2))*100,G=e=>parseFloat(e.toFixed(2)),Bt=(e,t)=>{const n=t.subtract(e).divide(e),o=new X(n.numerator,n.denominator);return te(o)};function Je(e){if(C(e))return e.gasUseEstimateUSD;if(S(e))return e.classicGasUseEstimateUSD}function et(e){switch(e){case N.DUTCH_V2:return y.DUTCH_V2_AUCTION;case N.DUTCH_LIMIT:case N.LIMIT_ORDER:return y.LIMIT_ORDER;default:return}}function tt({trade:e,allowedSlippage:t,outputFeeFiatValue:n,isBatched:o,batchId:r,includedPermitTransactionStep:i}){var a;const s=e instanceof B||e instanceof Ce||e instanceof Re||e instanceof Pe||e instanceof qe;return{routing:s?De(e):e.fillType,type:e.tradeType,ura_quote_id:s?e.quote.quote.quoteId:S(e)?e.quoteId:void 0,ura_request_id:s?e.quote.requestId:ze(e)?e.requestId:void 0,ura_quote_block_number:s?Ee(e)?e.quote.quote.blockNumber:void 0:C(e)?e.blockNumber??void 0:void 0,token_in_address:$(e.inputAmount.currency),token_out_address:$(e.outputAmount.currency),token_in_symbol:e.inputAmount.currency.symbol,token_out_symbol:e.outputAmount.currency.symbol,token_in_amount:H(e.inputAmount,e.inputAmount.currency.decimals),token_out_amount:H(e.outputAmount,e.outputAmount.currency.decimals),price_impact_basis_points:e instanceof B||!s&&C(e)?te(be(e)):void 0,chain_id:e.inputAmount.currency.chainId===e.outputAmount.currency.chainId?e.inputAmount.currency.chainId:void 0,chain_id_in:e.inputAmount.currency.chainId,chain_id_out:e.outputAmount.currency.chainId,estimated_network_fee_usd:s?e instanceof B?e.quote.quote.gasFeeUSD:void 0:(a=Je(e))===null||a===void 0?void 0:a.toString(),minimum_output_after_slippage:e instanceof B?e.minAmountOut.toSignificant(6):!s&&C(e)?e.minimumAmountOut(t).toSignificant(6):void 0,allowed_slippage:G(t),method:s?void 0:nt(e),fee_usd:n,token_out_detected_tax:G(e.outputTax),token_in_detected_tax:G(e.inputTax),offchain_order_type:s?et(e.routing):S(e)?e.offchainOrderType:void 0,transactionOriginType:Fe.Internal,is_batch:o,batch_id:r,included_permit_transaction_step:i}}const Dt=({trade:e,allowedSlippage:t,fiatValues:n,txHash:o,timeToSignSinceRequestMs:r,portfolioBalanceUsd:i,trace:a,isBatched:s,batchId:m,includedPermitTransactionStep:w})=>({...a,total_balances_usd:i,transaction_hash:o,token_in_amount_usd:n.amountIn,token_out_amount_usd:n.amountOut,time_to_sign_since_request_ms:r,...["routing"in e?Be(e):void 0],...tt({trade:e,allowedSlippage:t,outputFeeFiatValue:n.feeUsd,isBatched:s,batchId:m,includedPermitTransactionStep:w})});function nt(e){return S(e)?Ae.ROUTING_API:e.quoteMethod}export{St as FALLBACK_SWAP_REQUEST_POLL_INTERVAL_MS,yt as UNKNOWN_SIM_ERROR,qt as currencyAddressForSwapQuote,tt as formatCommonPropertiesForTrade,te as formatPercentInBasisPointsNumber,G as formatPercentNumber,Dt as formatSwapSignedAnalyticsEventProperties,H as formatToDecimal,Et as getDurationUntilTimestampSeconds,Bt as getPriceUpdateBasisPoints,$ as getTokenAddress,Ye as getUSDCostPerGas,xe as getWrapInfo,C as isClassicTrade,Ot as isExactInput,Rt as isLimitTrade,Pt as isPreviewTrade,Ct as isUniswapXSwapTrade,S as isUniswapXTrade,Ze as isUniswapXTradeType,ht as transformQuoteToTrade};
